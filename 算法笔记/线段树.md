## å¼•å…¥
çº¿æ®µæ ‘æ˜¯ç®—æ³•ç«èµ›ä¸­å¸¸ç”¨çš„ç”¨æ¥ç»´æŠ¤Â **åŒºé—´ä¿¡æ¯**Â çš„æ•°æ®ç»“æ„ã€‚

çº¿æ®µæ ‘å¯ä»¥åœ¨$O(\log N))$çš„æ—¶é—´å¤æ‚åº¦å†…å®ç°å•ç‚¹ä¿®æ”¹ã€åŒºé—´ä¿®æ”¹ã€åŒºé—´æŸ¥è¯¢ï¼ˆåŒºé—´æ±‚å’Œï¼Œæ±‚åŒºé—´æœ€å¤§å€¼ï¼Œæ±‚åŒºé—´æœ€å°å€¼ï¼‰ç­‰æ“ä½œ
> é€‚åˆè§£å†³é—®é¢˜ï¼š**å¤§åŒºé—´çš„è§£å¯ä»¥ä»å°åŒºé—´çš„è§£åˆå¹¶è€Œæ¥**
## çº¿æ®µæ ‘
### çº¿æ®µæ ‘çš„åŸºæœ¬ç»“æ„ä¸å»ºæ ‘
#### è¿‡ç¨‹
çº¿æ®µæ ‘å°†æ¯ä¸ªé•¿åº¦ä¸ä¸ºÂ 1Â çš„åŒºé—´åˆ’åˆ†æˆå·¦å³ä¸¤ä¸ªåŒºé—´é€’å½’æ±‚è§£ï¼ŒæŠŠæ•´ä¸ªçº¿æ®µåˆ’åˆ†ä¸ºä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œé€šè¿‡åˆå¹¶å·¦å³ä¸¤åŒºé—´ä¿¡æ¯æ¥æ±‚å¾—è¯¥åŒºé—´çš„ä¿¡æ¯ã€‚è¿™ç§æ•°æ®ç»“æ„å¯ä»¥æ–¹ä¾¿çš„è¿›è¡Œå¤§éƒ¨åˆ†çš„åŒºé—´æ“ä½œã€‚

æœ‰ä¸ªå¤§å°ä¸º5çš„æ•°ç»„$a = \{10, 11, 12, 13, 14\}$ï¼Œè¦å°†å…¶è½¬åŒ–ä¸ºçº¿æ®µæ ‘ï¼Œæœ‰ä»¥ä¸‹åšæ³•ï¼šè®¾çº¿æ®µæ ‘çš„æ ¹èŠ‚ç‚¹ç¼–å·ä¸º 1ï¼Œç”¨æ•°ç»„ $d$ æ¥ä¿å­˜æˆ‘ä»¬çš„çº¿æ®µæ ‘ï¼Œ$d_i$ç”¨æ¥ä¿å­˜çº¿æ®µæ ‘ä¸Šç¼–å·ä¸º $i$Â çš„èŠ‚ç‚¹çš„å€¼ï¼ˆè¿™é‡Œæ¯ä¸ªèŠ‚ç‚¹æ‰€ç»´æŠ¤çš„å€¼å°±æ˜¯è¿™ä¸ªèŠ‚ç‚¹æ‰€è¡¨ç¤ºçš„**åŒºé—´æ€»å’Œ**ï¼‰

æˆ‘ä»¬å…ˆç»™å‡ºè¿™æ£µçº¿æ®µæ ‘çš„å½¢æ€ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š
![image.png|475](https://cdn.jsdelivr.net/gh/BlackJack0083/image@main/img/20240510091140.png)

å›¾ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸­ç”¨çº¢è‰²å­—ä½“æ ‡æ˜çš„åŒºé—´ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹ç®¡è¾–çš„Â $a$ æ•°ç»„ä¸Šçš„ä½ç½®åŒºé—´ã€‚å¦‚Â $d_1$ æ‰€ç®¡è¾–çš„åŒºé—´å°±æ˜¯ï¼ˆ$[1,5]$$(a_1, ..., a_5)$ï¼‰ï¼Œå³$d_1$æ‰€ä¿å­˜çš„å€¼æ˜¯$a_1+a_2+...+a_5$ï¼Œ$d_1=60$è¡¨ç¤ºçš„æ˜¯$a_1+a_2+...+a_5 = 60$ã€‚

é€šè¿‡è§‚å¯Ÿä¸éš¾å‘ç°ï¼Œè¿™æ˜¯ä¸€æ£µå¹³è¡¡äºŒå‰æ ‘ï¼Œé™¤äº†æœ€åä¸€å±‚ï¼Œå…¶ä»–å±‚éƒ½æ˜¯æ»¡çš„ã€‚$d_i$çš„å·¦å„¿å­èŠ‚ç‚¹å°±æ˜¯ $d_{2\times i}$ï¼Œ$d_i$ çš„å³å„¿å­èŠ‚ç‚¹å°±æ˜¯ $d_{2\times i+1}$ã€‚å¦‚æœ $d_i$ è¡¨ç¤ºçš„æ˜¯åŒºé—´ $[s,t]$ï¼ˆå³ $d_i=a_s+a_{s+1}+ \cdots +a_t$ï¼‰çš„è¯ï¼Œé‚£ä¹ˆ $d_i$ çš„å·¦å„¿å­èŠ‚ç‚¹è¡¨ç¤ºçš„æ˜¯åŒºé—´ $[ s, \frac{s+t}{2} ]$ï¼Œ$d_i$çš„å³å„¿å­è¡¨ç¤ºçš„æ˜¯åŒºé—´ $[ \frac{s+t}{2} +1,t ]$ã€‚

åœ¨å®ç°æ—¶ï¼Œæˆ‘ä»¬è€ƒè™‘é€’å½’å»ºæ ‘ã€‚è®¾å½“å‰çš„æ ¹èŠ‚ç‚¹ä¸º $p$ï¼Œå¦‚æœæ ¹èŠ‚ç‚¹ç®¡è¾–çš„åŒºé—´é•¿åº¦å·²ç»æ˜¯ $1$ï¼Œåˆ™å¯ä»¥ç›´æ¥æ ¹æ® $a$ æ•°ç»„ä¸Šç›¸åº”ä½ç½®çš„å€¼åˆå§‹åŒ–è¯¥èŠ‚ç‚¹ã€‚å¦åˆ™æˆ‘ä»¬å°†è¯¥åŒºé—´ä»ä¸­ç‚¹å¤„åˆ†å‰²ä¸ºä¸¤ä¸ªå­åŒºé—´ï¼Œåˆ†åˆ«è¿›å…¥å·¦å³å­èŠ‚ç‚¹é€’å½’å»ºæ ‘ï¼Œæœ€ååˆå¹¶ä¸¤ä¸ªå­èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚

#### å»ºæ ‘
```c++
int tree[N * 4];

int ls(int p){
	return p << 1; // å·¦å„¿å­ï¼Œç¼–å·æ˜¯ p * 2*
}
int rs(int p){
	return p << 1 | 1;  // å³å„¿å­ï¼Œç¼–å·æ˜¯p*2+1
}

void push_up(int p){  // ä»ä¸‹å‘ä¸Šä¼ é€’åŒºé—´å€¼
	tree[p] = tree[ls(p)] + tree[rs(p)];
	// tree[p] = min(tree[ls(p)], tree[rs(p)]);  // æ±‚æœ€å°å€¼
}

void build(int p, int pl, int pr){   // èŠ‚ç‚¹ç¼–å·pæŒ‡å‘åŒºé—´[pl, pr]
	if(pl == pr){tree[p] = a[pl]; return;}  // æœ€åº•å±‚çš„å¶å­èŠ‚ç‚¹ï¼Œå­˜å¶å­èŠ‚ç‚¹çš„å€¼
	int mid = (pl + pr  >> 1);  // åˆ†æ²»ï¼šæŠ˜åŠ
	build(ls(p), pl, mid);  // é€’å½’å·¦å„¿å­
	build(rs(p), mid + 1, pr);  // é€’å½’å³å„¿å­
	push_up(p); 
}
```
æ³¨æ„ï¼šäºŒå‰æ ‘ç©ºé—´éœ€è¦å¼€$4 * N$ï¼Œå³å…ƒç´ æ•°é‡çš„4å€
å› ä¸ºå¯èƒ½æœ‰æç«¯æƒ…å†µï¼šæœ€åä¸€å±‚åªæœ‰1ä¸ªå…ƒç´ ï¼Œå€’æ•°ç¬¬äºŒå±‚Nä¸ªç‚¹ï¼Œå‰é¢çš„å±‚ä¹Ÿæ˜¯Nä¸ªç‚¹

### å•ç‚¹ä¿®æ”¹&åŒºé—´æŸ¥è¯¢
#### å•ç‚¹ä¿®æ”¹
å•ç‚¹ä¿®æ”¹ï¼Œéœ€è¦ä¿®æ”¹å¶å­èŠ‚ç‚¹ä¸Šå…ƒç´ çš„å€¼ï¼Œç„¶åä»ä¸‹å¾€ä¸Šæ›´æ–°çº¿æ®µæ ‘
å¯ä»¥ç›´æ¥ç”¨åŒºé—´ä¿®æ”¹çš„æ¿å­ï¼Œç„¶åæŠŠåŒºé—´å˜æˆå•ç‚¹å³å¯
#### åŒºé—´æœ€å€¼/åŒºé—´æ±‚å’Œ
ä»¥æœ€å¼€å§‹çš„å›¾ä¸ºä¾‹ï¼Œå¦‚æœè¦æŸ¥è¯¢åŒºé—´ $[1,5]$ çš„å’Œï¼Œé‚£ç›´æ¥è·å– $d_1$ çš„å€¼ $60$ å³å¯ã€‚

å¦‚æœè¦æŸ¥è¯¢çš„åŒºé—´ä¸º $[3,5]$ï¼Œæ­¤æ—¶å°±ä¸èƒ½ç›´æ¥è·å–åŒºé—´çš„å€¼ï¼Œä½†æ˜¯ $[3,5]$ å¯ä»¥æ‹†æˆ $[3,3]$ å’Œ $[4,5]$ï¼Œå¯ä»¥é€šè¿‡åˆå¹¶è¿™ä¸¤ä¸ªåŒºé—´çš„ç­”æ¡ˆæ¥æ±‚å¾—è¿™ä¸ªåŒºé—´çš„ç­”æ¡ˆã€‚æŸ¥è¯¢$[4,9]$ä¹Ÿå¯ä»¥ç”¨æŸ¥è¯¢$[4,5],[6,8],[9,9]$ä¸‰ä¸ªåŒºé—´è¿›è¡Œè¡¨ç¤º

ä¸€èˆ¬åœ°ï¼Œå¦‚æœè¦æŸ¥è¯¢çš„åŒºé—´æ˜¯ $[l,r]$ï¼Œåˆ™å¯ä»¥å°†å…¶æ‹†æˆæœ€å¤šä¸º $O(\log n)$ ä¸ª **æå¤§** çš„åŒºé—´ï¼Œåˆå¹¶è¿™äº›åŒºé—´å³å¯æ±‚å‡º $[l,r]$ çš„ç­”æ¡ˆã€‚

é€’å½’æŸ¥è¯¢æŸä¸ªèŠ‚ç‚¹$p$æ—¶($p$è¡¨ç¤ºçš„åŒºé—´ä¸º$[pl, pr]$)ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š
- $[l, r]$å®Œå…¨è¦†ç›–äº†$[pl, pr]$ï¼Œå³$l \leq pl \leq pr \leq r$ï¼Œç›´æ¥è¿”å› $p$ çš„å€¼
- $[l, r]$ä¸$[pl,pr]$éƒ¨åˆ†é‡å ï¼Œåˆ†åˆ«æœç´¢å·¦å³å­èŠ‚ç‚¹ã€‚$l < pr$ï¼Œç»§ç»­é€’å½’å·¦å­èŠ‚ç‚¹
```c++
int getsum(int l, int r, int p, int pl, int pr){
	// [l, r] ä¸ºæŸ¥è¯¢åŒºé—´, [pl, pr] ä¸ºå½“å‰èŠ‚ç‚¹åŒ…å«çš„åŒºé—´, p ä¸ºå½“å‰èŠ‚ç‚¹çš„ç¼–å·
	if(l <= pl && pr <= r) return tree[p];
	int mid = (pl + pr) >> 1, res = 0;
	// å¦‚æœå·¦å„¿å­ä»£è¡¨çš„åŒºé—´ [l, mid] ä¸è¯¢é—®åŒºé—´æœ‰äº¤é›†, åˆ™é€’å½’æŸ¥è¯¢å·¦å„¿å­
	if(l <= mid) res += query(l, r, ls(p), pl, mid);
	// å¦‚æœå³å„¿å­ä»£è¡¨çš„åŒºé—´ [mid + 1, r] ä¸è¯¢é—®åŒºé—´æœ‰äº¤é›†, åˆ™é€’å½’æŸ¥è¯¢å³å„¿å­
	if(r > mid) res +=  query(l, r, rs(p), mid + 1, pr);
	return res;
}
```
### åŒºé—´ä¿®æ”¹
ä½¿ç”¨**Lazy-tag**æŠ€æœ¯

å¦‚æœè¦æ±‚ä¿®æ”¹åŒºé—´ $[l,r]$ï¼ŒæŠŠæ‰€æœ‰åŒ…å«åœ¨åŒºé—´ $[l,r]$ ä¸­çš„èŠ‚ç‚¹éƒ½éå†ä¸€æ¬¡ã€ä¿®æ”¹ä¸€æ¬¡ï¼Œæ—¶é—´å¤æ‚åº¦æ— æ³•æ‰¿å—ã€‚æˆ‘ä»¬è¿™é‡Œè¦å¼•å…¥ä¸€ä¸ªå«åš ã€Œæ‡’æƒ°æ ‡è®°ã€ çš„ä¸œè¥¿ã€‚

æ‡’æƒ°æ ‡è®°ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡**å»¶è¿Ÿå¯¹èŠ‚ç‚¹ä¿¡æ¯çš„æ›´æ”¹**ï¼Œä»è€Œå‡å°‘å¯èƒ½ä¸å¿…è¦çš„æ“ä½œæ¬¡æ•°ã€‚æ¯æ¬¡æ‰§è¡Œä¿®æ”¹æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡æ‰“æ ‡è®°çš„æ–¹æ³•è¡¨æ˜è¯¥èŠ‚ç‚¹å¯¹åº”çš„åŒºé—´åœ¨**æŸä¸€æ¬¡æ“ä½œä¸­è¢«æ›´æ”¹**ï¼Œä½†**ä¸æ›´æ–°è¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„ä¿¡æ¯**ã€‚å®è´¨æ€§çš„ä¿®æ”¹åˆ™åœ¨**ä¸‹ä¸€æ¬¡è®¿é—®å¸¦æœ‰æ ‡è®°çš„èŠ‚ç‚¹æ—¶æ‰è¿›è¡Œ**ã€‚

ä»ç„¶ä»¥æœ€å¼€å§‹çš„å›¾ä¸ºä¾‹ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œè‹¥å¹²æ¬¡ç»™åŒºé—´å†…çš„æ•°åŠ ä¸Šä¸€ä¸ªå€¼çš„æ“ä½œã€‚æˆ‘ä»¬ç°åœ¨ç»™æ¯ä¸ªèŠ‚ç‚¹å¢åŠ ä¸€ä¸ª $t_i$ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å¸¦çš„æ ‡è®°å€¼ã€‚

æœ€å¼€å§‹æ—¶çš„æƒ…å†µæ˜¯è¿™æ ·çš„ï¼š
![image.png|450](https://cdn.jsdelivr.net/gh/BlackJack0083/image@main/img/20240517112050.png)
ç°åœ¨æˆ‘ä»¬å‡†å¤‡ç»™ $[3,5]$ ä¸Šçš„æ¯ä¸ªæ•°éƒ½åŠ ä¸Š 5ã€‚æ ¹æ®å‰é¢åŒºé—´æŸ¥è¯¢çš„ç»éªŒï¼Œæˆ‘ä»¬å¾ˆå¿«æ‰¾åˆ°äº†ä¸¤ä¸ªæå¤§åŒºé—´ $[3,3]$ å’Œ $[4,5]$ï¼ˆåˆ†åˆ«å¯¹åº”çº¿æ®µæ ‘ä¸Šçš„ 3 å·ç‚¹å’Œ 5 å·ç‚¹ï¼‰ã€‚

æˆ‘ä»¬ç›´æ¥åœ¨è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œå¹¶ç»™å®ƒä»¬æ‰“ä¸Šæ ‡è®°ï¼š
![image.png|450](https://cdn.jsdelivr.net/gh/BlackJack0083/image@main/img/20240517112124.png)

æˆ‘ä»¬å‘ç°ï¼Œ3 å·èŠ‚ç‚¹çš„ä¿¡æ¯è™½ç„¶è¢«ä¿®æ”¹äº†ï¼ˆå› ä¸ºè¯¥åŒºé—´ç®¡è¾–ä¸¤ä¸ªæ•°ï¼Œæ‰€ä»¥ $d_3$ åŠ ä¸Šçš„æ•°æ˜¯ $5 \times 2=10$ï¼‰ï¼Œä½†å®ƒçš„ä¸¤ä¸ªå­èŠ‚ç‚¹å´è¿˜æ²¡æ›´æ–°ï¼Œä»ç„¶ä¿ç•™ç€ä¿®æ”¹ä¹‹å‰çš„ä¿¡æ¯ã€‚ä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œè™½ç„¶ä¿®æ”¹ç›®å‰è¿˜æ²¡è¿›è¡Œï¼Œä½†å½“æˆ‘ä»¬è¦æŸ¥è¯¢è¿™ä¸¤ä¸ªå­èŠ‚ç‚¹çš„ä¿¡æ¯æ—¶ï¼Œæˆ‘ä»¬ä¼šåˆ©ç”¨æ ‡è®°ä¿®æ”¹è¿™ä¸¤ä¸ªå­èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œä½¿æŸ¥è¯¢çš„ç»“æœä¾æ—§å‡†ç¡®ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æŸ¥è¯¢ä¸€ä¸‹ $[4,4]$åŒºé—´ä¸Šå„æ•°å­—çš„å’Œã€‚

æˆ‘ä»¬é€šè¿‡é€’å½’æ‰¾åˆ° $[4,5]$ åŒºé—´ï¼Œå‘ç°è¯¥åŒºé—´å¹¶éæˆ‘ä»¬çš„ç›®æ ‡åŒºé—´ï¼Œä¸”è¯¥åŒºé—´ä¸Šè¿˜å­˜åœ¨æ ‡è®°ã€‚è¿™æ—¶å€™å°±åˆ°æ ‡è®°ä¸‹æ”¾çš„æ—¶é—´äº†ã€‚æˆ‘ä»¬å°†è¯¥åŒºé—´çš„ä¸¤ä¸ªå­åŒºé—´çš„ä¿¡æ¯æ›´æ–°ï¼Œå¹¶æ¸…é™¤è¯¥åŒºé—´ä¸Šçš„æ ‡è®°ã€‚
![image.png|475](https://cdn.jsdelivr.net/gh/BlackJack0083/image@main/img/20240517112304.png)
### luogu 3372
[P3372 ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘ 1 - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3372)
**æ³¨æ„ç¬¦å·ä¸è¦å†™åäº†ã€‚ã€‚ã€‚ã€‚**
```c++
#include<bits/stdc++.h>
using namespace std;
typedef long long ll;
const int N = 1e5 + 10;
ll a[N];  // æ•°ç»„å…ƒç´ 
ll tree[N * 4];  // è¡¨ç¤ºç¬¬iä¸ªèŠ‚ç‚¹çš„å€¼
ll tag[N * 4];  // lazy- tag
/*void push_down(ll p, ll pl, ll pr){  // ä¸èƒ½è¦†ç›–æ—¶ï¼ŒæŠŠtag ä¼ ç»™å­æ ‘
	if(tag[p]){Â Â Â Â Â Â Â Â Â Â //Â å¦‚æœå½“å‰èŠ‚ç‚¹çš„æ‡’æ ‡è®°éç©º,åˆ™æ›´æ–°å½“å‰èŠ‚ç‚¹ä¸¤ä¸ªå­èŠ‚ç‚¹çš„å€¼å’Œæ‡’æ ‡è®°å€¼  
Â Â Â Â Â Â Â Â intÂ midÂ =Â (plÂ +Â pr)Â >>Â 1; 
Â Â Â Â Â Â Â Â tree[pÂ *Â 2]Â +=Â tag[p]Â *Â (midÂ -Â plÂ +Â 1);Â Â //Â è®¡ç®—æ–°çš„å·¦å­æ ‘  
Â Â Â Â Â Â Â Â tree[pÂ *Â 2Â +Â 1]Â +=Â tag[p]Â *Â (prÂ -Â mid);Â Â //Â è®¡ç®—æ–°çš„å³å­æ ‘  
Â Â Â Â Â Â Â Â tag[pÂ *Â 2]Â +=Â tag[p];  
Â Â Â Â Â Â Â Â tag[pÂ *Â 2Â +Â 1]Â +=Â tag[p];  
Â Â Â Â Â Â Â Â tag[p]Â =Â 0;  
Â Â Â Â }  
}

void push_up(ll p){
	tree[p] = tree[ls(p)] + tree[rs(p)];
}
*/

voidÂ build(intÂ p,Â intÂ pl,Â intÂ pr){Â Â Â //Â èŠ‚ç‚¹ç¼–å·pæŒ‡å‘åŒºé—´[pl,Â pr]  
Â Â Â Â tag[p]Â =Â 0;Â Â //Â lazy-tagæ ‡è®°  
Â Â Â Â if(plÂ ==Â pr){tree[p]Â =Â a[pl];Â return;}Â Â //Â æœ€åº•å±‚çš„å¶å­èŠ‚ç‚¹ï¼Œå­˜å¶å­èŠ‚ç‚¹çš„å€¼  
Â Â Â Â intÂ midÂ =Â ((plÂ +Â pr)Â >>Â 1);Â Â //Â åˆ†æ²»ï¼šæŠ˜åŠ  
Â Â Â Â build(pÂ *Â 2,Â pl,Â mid);Â Â //Â é€’å½’å·¦å„¿å­  
Â Â Â Â build(pÂ *Â 2Â +Â 1,Â midÂ +Â 1,Â pr);Â Â //Â é€’å½’å³å„¿å­  
Â Â Â Â tree[p]Â =Â tree[pÂ *Â 2]Â +Â tree[pÂ *Â 2Â +Â 1];Â //Â ä»ä¸‹å¾€ä¸Šä¼ é€’åŒºé—´å€¼  
}  
  
//Â å°†ä¸Šé¢ä¸¤ä¸ªå‡½æ•°ç²¾ç®€åˆ°updateéƒ¨åˆ†  
voidÂ update(llÂ l,Â llÂ r,Â llÂ p,Â llÂ pl,Â llÂ pr,Â llÂ d){Â Â //Â åŒºé—´ä¿®æ”¹  
Â Â Â Â //Â [l,Â r]Â ä¸ºä¿®æ”¹åŒºé—´ï¼ŒdÂ ä¸ºè¢«ä¿®æ”¹çš„å…ƒç´ çš„å˜åŒ–é‡ï¼Œ[pl,Â pr]ä¸ºå½“å‰èŠ‚ç‚¹åŒ…å«çš„åŒºé—´ï¼Œpä¸ºå½“å‰èŠ‚ç‚¹çš„ç¼–å·  
Â Â Â Â if(lÂ <=Â plÂ &&Â prÂ <=Â r){Â Â //Â è¯¥èŠ‚ç‚¹èŒƒå›´è¢«å®Œå…¨è¦†ç›–ï¼Œç›´æ¥è¿”å›è¯¥èŠ‚ç‚¹ï¼Œå­æ ‘ä¸ç”¨å†æ·±å…¥äº†  
Â Â Â Â Â Â Â Â tag[p]Â +=Â d;Â Â //Â ç»™èŠ‚ç‚¹pæ‰“ä¸Štagæ ‡è®°ï¼Œæ›´æ–°tree  
Â Â Â Â Â Â Â Â tree[p]Â +=Â dÂ *Â (prÂ -Â plÂ +Â 1);Â Â //Â è¯´æ˜æœ‰å¤šå°‘èŠ‚ç‚¹ç»™å¢åŠ äº†  
Â Â Â Â Â Â Â Â return;  
Â Â Â Â }  
Â Â Â Â //Â push_down(p,Â pl,Â pr);Â //Â å¦‚æœä¸èƒ½è¦†ç›–ï¼ŒæŠŠtagä¼ ç»™å­æ ‘  
Â Â Â Â intÂ midÂ =Â (plÂ +Â pr)Â >>Â 1;  
Â Â Â Â 
	if(tag[p]){Â Â Â Â Â Â Â Â Â Â //Â å¦‚æœå½“å‰èŠ‚ç‚¹çš„æ‡’æ ‡è®°éç©º,åˆ™æ›´æ–°å½“å‰èŠ‚ç‚¹ä¸¤ä¸ªå­èŠ‚ç‚¹çš„å€¼å’Œæ‡’æ ‡è®°å€¼  
Â Â Â Â Â Â Â Â tree[pÂ *Â 2]Â +=Â tag[p]Â *Â (midÂ -Â plÂ +Â 1);Â Â //Â è®¡ç®—æ–°çš„å·¦å­æ ‘  
Â Â Â Â Â Â Â Â tree[pÂ *Â 2Â +Â 1]Â +=Â tag[p]Â *Â (prÂ -Â mid);Â Â //Â è®¡ç®—æ–°çš„å³å­æ ‘  
Â Â Â Â Â Â Â Â tag[pÂ *Â 2]Â +=Â tag[p];  
Â Â Â Â Â Â Â Â tag[pÂ *Â 2Â +Â 1]Â +=Â tag[p];  
Â Â Â Â Â Â Â Â tag[p]Â =Â 0;  
Â Â Â Â }  
Â Â Â Â if(lÂ <=Â mid)Â update(l,Â r,Â pÂ *Â 2,Â pl,Â mid,Â d);Â //Â é€’å½’å·¦å­æ ‘  
Â Â Â Â if(rÂ >Â mid)Â update(l,Â r,Â pÂ *Â 2Â +Â 1,Â midÂ +Â 1,Â pr,Â d);Â //Â é€’å½’å³å­æ ‘  
Â Â Â Â //Â push_up(p);  
Â Â Â Â tree[p]Â =Â tree[pÂ *Â 2]Â +Â tree[pÂ *Â 2Â +Â 1];  
}  
  
llÂ getsum(intÂ l,Â intÂ r,Â intÂ p,Â intÂ pl,Â intÂ pr){  
Â Â Â Â //Â [l,Â r]Â ä¸ºæŸ¥è¯¢åŒºé—´,Â [pl,Â pr]Â ä¸ºå½“å‰èŠ‚ç‚¹åŒ…å«çš„åŒºé—´,Â pÂ ä¸ºå½“å‰èŠ‚ç‚¹çš„ç¼–å·  
Â Â Â Â if(lÂ <=Â plÂ &&Â prÂ <=Â r)Â returnÂ tree[p];Â //Â å®Œå…¨è¦†ç›–ï¼Œç›´æ¥è¿”å›  
	llÂ midÂ =Â (plÂ +Â pr)Â >>Â 1,Â resÂ =Â 0;  
	if(tag[p]){Â Â Â Â Â Â Â Â Â Â //Â å¦‚æœå½“å‰èŠ‚ç‚¹çš„æ‡’æ ‡è®°éç©º,åˆ™æ›´æ–°å½“å‰èŠ‚ç‚¹ä¸¤ä¸ªå­èŠ‚ç‚¹çš„å€¼å’Œæ‡’æ ‡è®°å€¼  
		tree[pÂ *Â 2]Â +=Â tag[p]Â *Â (midÂ -Â plÂ +Â 1);Â Â //Â è®¡ç®—æ–°çš„å·¦å­æ ‘  
		tree[pÂ *Â 2Â +Â 1]Â +=Â tag[p]Â *Â (prÂ -Â mid);Â Â //Â è®¡ç®—æ–°çš„å³å­æ ‘  
		tag[pÂ *Â 2]Â +=Â tag[p];  
		tag[pÂ *Â 2Â +Â 1]Â +=Â tag[p];  
		tag[p]Â =Â 0;  
Â Â Â Â }  
  
Â Â Â Â //Â å¦‚æœå·¦å„¿å­ä»£è¡¨çš„åŒºé—´Â [l,Â mid]Â ä¸è¯¢é—®åŒºé—´æœ‰äº¤é›†,Â åˆ™é€’å½’æŸ¥è¯¢å·¦å„¿å­  
Â Â Â Â if(lÂ <=Â mid)Â resÂ +=Â getsum(l,Â r,Â pÂ *Â 2,Â pl,Â mid);  
Â Â Â Â //Â å¦‚æœå³å„¿å­ä»£è¡¨çš„åŒºé—´Â [midÂ +Â 1,Â r]Â ä¸è¯¢é—®åŒºé—´æœ‰äº¤é›†,Â åˆ™é€’å½’æŸ¥è¯¢å³å„¿å­  
Â Â Â Â if(rÂ >Â mid)Â resÂ +=Â Â getsum(l,Â r,Â pÂ *Â 2Â +Â 1,Â midÂ +Â 1,Â pr);  
Â Â Â Â returnÂ res;  
}  
  
intÂ main(void){  
Â Â Â Â llÂ n,Â m;  
Â Â Â Â scanf("%lld%lld",Â &n,Â &m);  
Â Â Â Â for(llÂ iÂ =Â 1;Â iÂ <=Â n;Â i++)Â scanf("%lld",Â &a[i]);  
Â Â Â Â build(1,Â 1,Â n);Â //Â å»ºæ ‘  
Â Â Â Â Â Â Â Â while(m--){  
Â Â Â Â Â Â Â Â llÂ q,Â l,Â r,Â d;  
Â Â Â Â Â Â Â Â scanf("%lld",Â &q);  
Â Â Â Â Â Â Â Â if(qÂ ==Â 1){  
Â Â Â Â Â Â Â Â Â Â Â Â scanf("%lld%lld%lld",Â &l,Â &r,Â &d);  
Â Â Â Â Â Â Â Â Â Â Â Â update(l,Â r,Â 1,Â 1,Â n,Â d);  
Â Â Â Â Â Â Â Â }else{  
Â Â Â Â Â Â Â Â Â Â Â Â scanf("%lld%lld",Â &l,Â &r);  
Â Â Â Â Â Â Â Â Â Â Â Â printf("%lld\n",Â getsum(l,Â r,Â 1,Â 1,Â n));  
Â Â Â Â Â Â Â Â }  
Â Â Â Â }  
Â Â Â Â returnÂ 0;  
}
```
è¿™ä¸ªåœ°æ–¹åœ¨`getsum`å’Œ`update`çš„æ—¶å€™å‡è¦è¿›è¡Œ`push_down`æ“ä½œ
ä¾‹å¦‚ï¼Œåšä¸¤æ¬¡åŒºé—´ä¿®æ”¹ï¼Œä¸€æ¬¡æ˜¯$[4,9]$ï¼Œä¸€æ¬¡æ˜¯$[5,8]$ï¼Œå®ƒä»¬éƒ½ä¼šå½±å“$5:[4,5]$è¿™ä¸ªèŠ‚ç‚¹ã€‚ç¬¬ä¸€æ¬¡ä¿®æ”¹åŒºé—´$[4,9]$è¦†ç›–äº†èŠ‚ç‚¹$5$ï¼Œç”¨`tag[5]`åšäº†è®°å½•ï¼›ç¬¬äºŒæ¬¡ä¿®æ”¹åŒºé—´$[5,8]$ä¸èƒ½è¦†ç›–èŠ‚ç‚¹5ï¼Œéœ€è¦å‘ä¸‹æœç´¢åˆ°èŠ‚ç‚¹$11:[5,5]$ï¼Œä»è€Œç ´åäº†`tag[5]`ï¼Œæ­¤æ—¶åŸ`tag[5]`è®°å½•çš„åŒºé—´ç»Ÿä¸€ä¿®æ”¹å°±ä¸å¾—ä¸å‘å®ƒçš„å­èŠ‚ç‚¹ä¼ é€’å’Œæ‰§è¡Œäº†ã€‚
ä¼ é€’åï¼Œ`tag[5]`å¤±å»äº†ä½œç”¨ï¼Œéœ€è¦æ¸…ç©º

ä½¿ç”¨ç»“æ„ä½“ï¼š
```c++
#include<bits/stdc++.h>
using namespace std;
typedef long long ll;
const int N = 1e5 + 10;

#define lc p << 1
#define rc p << 1|1
int n, w[N];
struct node{
	int l, r, sum, add;
}tr[N * 4];

void build(int p, int l, int r){
	tr[p] = {l, r, w[l]};
	if(l == r) return ;
	int m = l + r >> 1;
	build(lc, l, m);
	build(rc, m + 1, r);
	tr[p].sum = tr[lc].sum + tr[rc].sum;
}
// å•ç‚¹ä¿®æ”¹
void update(int p, int x, int k){  // æ ¹èŠ‚ç‚¹ï¼ŒæŸ¥çš„ä½ç½®ï¼Œæ›´æ–°å€¼
	if(tr[p].l == x && tr[p].r == x){  // å¶å­åˆ™ä¿®æ”¹
		tr[p].sum += k;
		return;
	}
	int m = tr[p].l + tr[p].r >> 1;
	if(x <= m) update(lc, x, k);
	if(x > m) update(rc, x, k);
	tr[p].sum = tr[lc].sum + tr[rc].sum;
}.r <= y
// æ²¡æœ‰lazytagçš„åŒºé—´æŸ¥è¯¢
void query(int p, int x, int y){
	if(x <= tr[p].l && tr[p].r <= y) return tr[p].sum;
	int m = tr[p].l + tr[p].r >> 1;
	int sum = 0;
	if(x <= m) sum += query(lc, x, y);
	if(y > m) sum += query(rc, x, y);
	return sum;
}
// åŒºé—´ä¿®æ”¹
void pushup(int p){
	tr[p].sum = tr[lc].sum + tr[rc].sum;
}

void pushdown(int p){
	if(tr[p].add){
		tr[lc].sum += tr[p].add * (tr[lc].r - tr[lc].l + 1);
		tr[rc].sum += tr[p].add * (tr[rc].r - tr[rc].l + 1);
		tr[lc].add += tr[p].add;
		tr[rc].add += tr[p].add;
		tr[p].add = 0;
	}
}

void update(int p, int x, int y, int k){
	if(x <= tr[p].l && tr[p].r <= y){
		tr[p].sum += (tr[p].r - tr[p].l + 1) * k;
		tr[p].add += k;
		return;
	}
	int m = tr[p].l + tr[p].r >> 1;
	pushdown(p);
	if(x <= m) update(lc, x, y, k);
	if(y > m) update(rc, x, y, k);
	pushup(p);
}
// æœ‰lazytagçš„åŒºé—´æŸ¥è¯¢(åªéœ€è¦å¤šåŠ ä¸Šä¸€å¥pushdown)
void query(int p, int x, int y){
	if(x <= tr[p].l && tr[p].r <= y) return tr[p].sum;
	int m = tr[p].l + tr[p].r >> 1;
	pushdown(p);
	int sum = 0;
	if(x <= m) sum += query(lc, x, y);
	if(y > m) sum += query(rc, x, y);
	return sum;
}
```
### ç‰¹æ®Šçš„åŒºé—´ä¿®æ”¹ hdu 4027
[Problem - 4027 (hdu.edu.cn)](https://acm.hdu.edu.cn/showproblem.php?pid=4027)
æ“ä½œï¼š
1. å¯¹åŒºé—´å†…çš„æ¯ä¸ªæ•°è¿›è¡Œå¼€æ–¹($E_i < 2^{63}$)
2. åŒºé—´æ±‚å’Œ
è¯¥é¢˜å¯¹åŒºé—´è¿›è¡Œæ“ä½œï¼Œæ˜¾ç„¶æ˜¯ç”¨çº¿æ®µæ ‘ã€‚
ä¸¤ä¸ªæ“ä½œåˆ†åˆ«æ˜¯å¯¹åŒºé—´è¿›è¡Œå¼€æ–¹å’ŒåŒºé—´æ±‚å’Œï¼Œå¯¹åŒºé—´ä¸­æˆ˜èˆ°çš„èƒ½é‡å€¼è¿›è¡Œå¼€æ–¹æ“ä½œï¼Œå¾ˆç®€å•çš„ä¼šæƒ³åˆ°ç”¨lazyæ•°ç»„ï¼Œä½†ä¼šå‘ç°æ— æ³•åƒåŒºé—´åŠ å‡å†™å‡ºç±»ä¼¼çš„å¼å­ã€‚
ä»”ç»†æƒ³ä¾¿å¯å‘ç°æ•°æ®æœ€å¤§å€¼ä¸º$2^{63}$ï¼Œå› æ­¤æ¯ä¸ªæ•°æœ€å¤šèƒ½å¼€6-7æ¬¡æ–¹ï¼Œä¹‹å**1å¼€æ–¹ä»ç„¶ä¸º1**.
å› æ­¤å¦‚æœä¸€ä¸ªåŒºé—´ä¸­çš„å€¼å…¨ä¸º1ï¼Œåˆ™ä»–å°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•æ“ä½œå³å¯ã€‚è‹¥åŒºé—´ä¸æ»¡è¶³æ¡ä»¶åˆ™è¿›è¡Œå•ç‚¹æ›´æ–°ï¼Œå°†æ¯ä¸ªå€¼å¼€æ–¹å³å¯ã€‚åŒºé—´æ±‚å’Œå°±æ˜¯å¾ˆæ™®é€šçš„åŒºé—´æ±‚å’Œäº†

å‘ç°è¿™é“é¢˜ä¸éœ€è¦ç”¨åˆ°`lazy`æ•°ç»„ï¼Œåªéœ€è¦åœ¨`update`åˆ¤æ–­çš„æ—¶å€™åŠ ä¸Šæ¡ä»¶`tree[p] == pr-pl+1`ï¼Œè¿™æ ·è¦æ˜¯åŒºé—´é‡Œé¢éƒ½æ˜¯`1`å°±`return`ï¼Œä¹Ÿèƒ½å‰ªæã€‚ç„¶åå¯¹`tree`èŠ‚ç‚¹ä¸Šçš„å€¼å°±ç›´æ¥å¼€æ–¹å³å¯
```c++
#include<iostream>  
#include<cmath>  
  
usingÂ namespaceÂ std;  
  
typedefÂ longÂ longÂ ll;  
constÂ intÂ NÂ =Â 1e5Â +Â 10;  
llÂ a[N];Â Â //Â æ•°ç»„å…ƒç´   
llÂ tree[NÂ *Â 4];Â Â //Â è¡¨ç¤ºç¬¬iä¸ªèŠ‚ç‚¹çš„å€¼  
  
voidÂ build(intÂ p,Â intÂ pl,Â intÂ pr){  
Â Â Â Â if(plÂ ==Â pr){tree[p]Â =Â a[pl];Â return;}Â Â //Â æœ€åº•å±‚çš„å¶å­èŠ‚ç‚¹ï¼Œå­˜å¶å­èŠ‚ç‚¹çš„å€¼  
Â Â Â Â llÂ midÂ =Â ((plÂ +Â pr)Â >>Â 1);Â Â //Â åˆ†æ²»ï¼šæŠ˜åŠ  
Â Â Â Â build(pÂ *Â 2,Â pl,Â mid);Â Â //Â é€’å½’å·¦å„¿å­  
Â Â Â Â build(pÂ *Â 2Â +Â 1,Â midÂ +Â 1,Â pr);Â Â //Â é€’å½’å³å„¿å­  
Â Â Â Â tree[p]Â =Â tree[pÂ *Â 2]Â +Â tree[pÂ *Â 2Â +Â 1];Â Â //Â ä»ä¸‹å¾€ä¸Šä¼ é€’åŒºé—´å€¼  
}  
  
voidÂ update(llÂ l,Â llÂ r,Â llÂ p,Â llÂ pl,Â llÂ pr){  
Â Â Â Â if(lÂ <=Â plÂ &&Â prÂ <=Â rÂ &&Â tree[p]Â ==Â prÂ -Â plÂ +Â 1){  
Â Â Â Â Â Â Â Â return;Â Â Â Â Â Â 
	}  
	if(plÂ ==Â pr){  
		tree[p]Â =Â (ll)(sqrt(tree[p]));  
		return;  
Â Â Â Â }  
  
Â Â Â Â llÂ midÂ =Â (plÂ +Â pr)Â >>Â 1;  
Â Â Â Â if(lÂ <=Â mid)Â update(l,Â r,Â pÂ *Â 2,Â pl,Â mid);Â Â //Â é€’å½’å·¦å­æ ‘  
Â Â Â Â if(rÂ >Â mid)Â update(l,Â r,Â pÂ *Â 2Â +Â 1,Â midÂ +Â 1,Â pr);Â Â //Â é€’å½’å³å­æ ‘  
Â Â Â Â tree[p]Â =Â tree[pÂ *Â 2]Â +Â tree[pÂ *Â 2Â +Â 1];Â Â //Â pushupæ“ä½œ  
}  
  
llÂ getsum(intÂ l,Â intÂ r,Â intÂ p,Â intÂ pl,Â intÂ pr){  
Â Â Â Â if(lÂ <=Â plÂ &&Â prÂ <=Â r)Â returnÂ tree[p];Â Â //Â å®Œå…¨è¦†ç›–ï¼Œç›´æ¥è¿”å›  
Â Â Â Â llÂ midÂ =Â (plÂ +Â pr)Â >>Â 1,Â resÂ =Â 0;  
//Â Â Â Â push_down(p,Â pl,Â pr);  
Â Â Â Â if(lÂ <=Â mid)Â resÂ +=Â getsum(l,Â r,Â pÂ *Â 2,Â pl,Â mid);Â Â //Â é€’å½’æŸ¥è¯¢å·¦å„¿å­  
Â Â Â Â if(rÂ >Â mid)Â resÂ +=Â getsum(l,Â r,Â pÂ *Â 2Â +Â 1,Â midÂ +Â 1,Â pr);Â Â //Â é€’å½’æŸ¥è¯¢å³å„¿å­  
Â Â Â Â returnÂ res;Â Â 
}  
  
intÂ main(void){  
	llÂ n,Â m,Â cÂ =Â 1;  
Â Â Â Â while(cinÂ >>Â n){  
Â Â Â Â Â Â Â Â coutÂ <<Â "CaseÂ #"Â <<Â c++Â <<Â ":"Â <<Â endl;  
Â Â Â Â Â Â Â Â for(llÂ iÂ =Â 1;Â iÂ <=Â n;Â i++)Â scanf("%lld",Â &a[i]);  
Â Â Â Â Â Â Â Â build(1,Â 1,Â n);Â Â //Â å»ºæ ‘  
Â Â Â Â Â Â Â Â scanf("%lld",Â &m);  
Â Â Â Â Â Â Â Â while(m--){  
Â Â Â Â Â Â Â Â Â Â Â Â llÂ q,Â l,Â r;  
Â Â Â Â Â Â Â Â Â Â Â  scanf("%lld",Â &q);  
Â Â Â Â Â Â Â Â Â Â Â Â if(qÂ ==Â 0){  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â scanf("%lld%lld",Â &l,Â &r);  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if(lÂ >Â r)Â swap(l,Â r);  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â update(l,Â r,Â 1,Â 1,Â n);  
Â Â Â Â Â Â Â Â Â Â Â Â }else{  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â scanf("%lld%lld",Â &l,Â &r);  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if(lÂ >Â r)Â swap(l,Â r);  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â printf("%lld\n",Â getsum(l,Â r,Â 1,Â 1,Â n));  
Â Â Â Â Â Â Â Â Â Â Â Â }  
Â Â Â Â Â Â Â Â }  
Â Â Â Â Â Â Â Â coutÂ <<Â endl;  
Â Â Â Â }  
	returnÂ 0;Â Â 
}
```
### å¤šä¸ªæ“ä½œ 
#### æ´›è°· 3373 çº¿æ®µæ ‘2
[P3373 ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘ 2 - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3373)
1. `add`
2. `multi`
3. åŒºé—´æ±‚å’Œå–æ¨¡ç»“æœ
å‘ç°ä¸€ä¸ª`tag`æ²¡æœ‰åŠæ³•ä¿å­˜ä¸¤ä¸ªæ“ä½œï¼Œäºæ˜¯å¯¹`add`å’Œ`multi`æ“ä½œåˆ†åˆ«ç”¨`tag1`å’Œ`tag2`
##### åŒºé—´åŠ æ³•
è¿˜æ˜¯ä¸€æ ·
```c++
tag1[p] += k % MOD;
tree[p] += (k * (pr - pl + 1)) % MOD;
```
##### åŒºé—´ä¹˜æ³•
**å…ˆä¹˜ååŠ **
> [!note] ä¸ºä»€ä¹ˆè¦å…ˆä¹˜ååŠ ï¼Ÿ
> é¦–å…ˆæˆ‘ä»¬å›å¿†ä¸€ä¸‹çº¿æ®µæ ‘ï¼‘çš„åŠ æ³•æ ‡è®°**ä»–å…¶å®æ˜¯æ‰“åœ¨çˆ¶äº²èŠ‚ç‚¹ä¸Šçš„æ ‡è®°å„¿å­åŠ å¤šå°‘çš„**ï¼Œæ‰“å®Œæ ‡è®°çš„åŒæ—¶çˆ¶äº²çš„$sum$å…¶å®å·²ç»åŠ ä¸Šäº†$ğ‘ğ‘‘ğ‘‘ \times ğ‘™ğ‘’ğ‘›$
> é‚£æˆ‘ä»¬å›åˆ°è¿™é“é¢˜æˆ‘ä»¬å‘ç°é¢˜ç›®è¦æ±‚åœ¨åŠ æ•°çš„åŒæ—¶**è¿˜è¦åŒºé—´ä¹˜**ï¼Œå› æ­¤éœ€è¦ä¸¤ä¸ªtag
> 
> ç´§æ¥ç€æƒ³åˆ°`pushdown`æ“ä½œä¹‹åæˆ‘ä»¬åˆå‘ç°å¿…é¡»åœ¨å‘ä¸‹ä¼ é€’lazytagçš„æ—¶å€™äººä¸ºåœ°ä¸ºè¿™ä¸¤ä¸ªlazytagè§„å®šä¸€ä¸ªå…ˆåé¡ºåºï¼Œæ’åˆ—ç»„åˆä¸€ä¸‹åªæœ‰ä¸¤ç§æƒ…å†µï¼š
>
>1. åŠ æ³•ä¼˜å…ˆ
>å³$tree[p * 2] = ((tree[p * 2] + tag_{add}[p]) \times tag_{mul}[p]) \% MOD$ï¼Œä½†æ˜¯è¿™æ ·ä¸å¥½è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœæ”¹å˜addçš„æ•°å€¼ï¼Œmulä¹Ÿéœ€è¦å˜æˆåˆ†æ•°å°æ•°ï¼Œä¼šæŸå¤±ç²¾åº¦ï¼›
>2. ä¹˜æ³•ä¼˜å…ˆ
>å³$tree[p * 2] = ((tree[p * 2]  \times tag_{mul}[p]) + tag_{add}[p] \times length) \% MOD$ï¼Œè¿™æ ·å¦‚æœæ”¹å˜addçš„æ•°å€¼å°±åªä¼šæ”¹å˜addï¼Œæ”¹å˜mulçš„æ—¶å€™å°±æŠŠaddå¯¹åº”çš„ä¹˜èµ·æ¥å°±å¥½ï¼Œä¸ä¼šæŸå¤±ç²¾åº¦
>
> æ¯”å¦‚ç°åœ¨æœ‰3ä¸ªæ•°1,2,3
>1. å…ˆå…¨éƒ¨åŠ 2
>2. å†å…¨éƒ¨ä¹˜3
>3. æœ€åå…¨éƒ¨åŠ 4
>
>- å…ˆåŠ åä¹˜ï¼š
>	$sum = (tree[1] + 2 + 4/3) * 3 + 4 + (tree[2] + 2 + 4/3) * 3 + (tree[3] + 2 + 4/3) * 3$
>- å…ˆä¹˜ååŠ ï¼š
>	$sum = (tree[1] * 3 + 2 * 3 + 4) + (tree[2] * 3 + 2 * 3 + 4) + (tree[3] * 3 + 2 * 3 + 4)$
>
>æ˜¾ç„¶ä¸‹é¢çš„æ›´å¥½
```c++
tag1[p] = (tag1[p] * k) % MOD;
tag2[p] = (tag2[p] * k) % MOD;
tree[p] = (tree[p] * k) % MOD;
```
##### push_downçš„ç»´æŠ¤
ç°åœ¨è¦ä¸‹ä¼ ä¸¤ä¸ªæ ‡è®°ï¼šÂ `add`Â å’ŒÂ `mul`Â ã€‚
`sum`Â ï¼šå› ä¸ºÂ `add`Â ä¹‹å‰å·²ç»ä¹˜è¿‡ï¼Œæ‰€ä»¥åœ¨å­å­©å­ä¹˜è¿‡Â `mul`Â åç›´æ¥åŠ å°±è¡Œã€‚
`mul`Â ï¼šç›´æ¥ä¹˜ã€‚
`add`Â ï¼šå› ä¸ºÂ `add`Â çš„å€¼æ˜¯è¦åŒ…æ‹¬ä¹˜ä¹‹åçš„å€¼ï¼Œæ‰€ä»¥å­å­©å­è¦å…ˆä¹˜ä¸ŠÂ `mul`Â ã€‚
è¿™é‡Œä¸æ˜¯å¾ˆå¥½è¡¨ç¤º(é¢˜è§£ç”¨çš„éƒ½æ˜¯ç»“æ„ä½“ï¼Œæˆ‘ç”¨çš„æ•°ç»„...)ï¼Œè§ä¸‹é¢çš„ä»£ç 
```c++
#include<bits/stdc++.h>
using namespace std;

typedef long long ll;

const int N =  6;
ll a[N], mod;
//ll tree[N * 4], tag1[N * 4], tag2[N * 4];
ll tree[N * 2], tag1[N * 2], tag2[N * 2];

void build(ll p, ll pl, ll pr){
	tag1[p] = 0;
	tag2[p] = 1;
	
	if(pl == pr){
		tree[p] = a[pl] % mod;  // æœ€åº•å±‚çš„å¶å­èµ‹å€¼
		return;
	}
	
	ll mid = (pl + pr) >> 1;
	build(p * 2, pl, mid);
	build(p * 2 + 1, mid + 1, pr);
	
	tree[p] = (tree[p * 2] + tree[p * 2 + 1]) % mod;
}

void add_tag(ll p, ll pl, ll pr, ll d1, ll d2){
	tree[p] = (tree[p] * d2 + d1 * (pr - pl + 1)) % mod;
	tag2[p] = (tag2[p] * d2) % mod;
	tag1[p] = (tag1[p] * d2 + d1) % mod;
}

void push_down(ll p, ll pl, ll pr){
	if(tag1[p] || tag2[p] != 1){
		ll mid = (pl + pr) >> 1;

		add_tag(p * 2, pl, mid, tag1[p], tag2[p]);
		add_tag(p * 2 + 1, mid + 1, pr, tag1[p], tag2[p]);
		
		// æ¢å¤tag
		tag1[p] = 0;
		tag2[p] = 1;
	}
}

void update(ll l, ll r, ll p, ll pl, ll pr, ll op, ll k){
	if(l <= pl && pr <= r){
		if(op == 1){
			tag1[p] = (tag1[p] * k) % mod;
			tag2[p] = (tag2[p] * k) % mod;
			tree[p] = (tree[p] * k) % mod;
			return;
		}else{
			tag1[p] = (tag1[p] + k) % mod;
			tree[p] = (tree[p] + k * (pr - pl + 1))% mod;
			return;
		}
	}
	
	push_down(p, pl, pr);
	ll mid = (pl + pr) >> 1;
	if(l <= mid)update(l, r, p * 2, pl, mid, op, k);
	if(r > mid)update(l, r, p * 2 + 1, mid + 1, pr, op, k);
	
	tree[p] = (tree[p * 2] + tree[p * 2 + 1]) % mod;
	return;
}

ll query(ll l, ll r, ll p, ll pl , ll pr){
	if(pl >= l && r >= pr) return tree[p];
	push_down(p, pl, pr);
	ll res = 0;
	ll mid = (pl + pr) >> 1;
	if (l <= mid) res = (res + query(l, r, p * 2, pl, mid)) % mod;
	if(r > mid) res = (res + query(l, r, p * 2 + 1, mid + 1, pr)) % mod;
	
	return res;
}

int main(void){
	ll n, m, x, y, k;
	int op;
	scanf("%lld%lld%lld", &n, &m, &mod);
	for(int i = 1; i <= n; i++) scanf("%lld", &a[i]);
	build(1, 1, n);
	
	while(m--){
		scanf("%d", &op);
		if(op == 1){
			scanf("%lld%lld%lld", &x, &y, &k);
			update(x, y, 1, 1, n, op, k);
		}else if(op == 2){
			scanf("%lld%lld%lld", &x, &y, &k);
			update(x, y, 1, 1, n, op, k);
		}else{
			scanf("%lld%lld", &x, &y);
			printf("%lld\n", query(x, y, 1, 1, n));
		}
	}
	
	return 0;
}
```
#### hdu 4578
[Transformation - HDU 4578 - Virtual Judge (vjudge.net)](https://vjudge.net/problem/HDU-4578)
1. `add`ä¿®æ”¹ï¼Œå¯¹åŒºé—´æ¯ä¸ªæ•°éƒ½åŠ `c`
2. `multi`ä¿®æ”¹ï¼Œå¯¹åŒºé—´æ¯ä¸ªæ•°éƒ½ä¹˜`c`
3. `change`ä¿®æ”¹ï¼ŒåŒºé—´å†…æ¯ä¸ªæ•°éƒ½ç»Ÿä¸€ä¸º`c`
4. `sum`ï¼Œå¯¹åŒºé—´å†…æ¯ä¸ªæ•°çš„$p$æ¬¡æ–¹æ±‚å’Œï¼Œ$1\leq p \leq 3$

##### é¢˜è§£
æ“ä½œç›¸å½“å¤šï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æŠŠä»–ç®€åŒ–æˆä¸¤ä¸ªï¼šåŠ å’Œä¹˜ã€‚

ä»¤$x = a \times x + b$ï¼Œå³å¯¹ä¸€ä¸ª$x$ï¼Œä»¤å®ƒä¹˜ä»¥$a$ï¼Œå†åŠ ä¸Š$b$ï¼Œè§‚å¯Ÿå„ä¸ªå’Œçš„æƒ…å†µï¼š
$$sum1 = \sum x = \sum (a \times x + b) = a \times sum1 + b \times length$$
$$sum2 = \sum x^2 = \sum (a \times x + b)^2 = a ^2 \times sum2 + 2 \times a \times b \times sum1 + b^2 \times length$$
$$sum3 = \sum x^3 = \sum(a\times x \times b)^3 = a^3 \times sum3 + 3 \times a^2 \times b \times sum2 +3 \times b^2 \times a \times sum1 +b^3 \times length$$
- æ‰€ä»¥å¯¹äºåŠ ï¼Œä¹˜æ ‡è®°ä¸º1ï¼ŒåŠ æ ‡è®°ä¸ºcã€‚
- å¯¹äºä¹˜ï¼Œä¹˜æ ‡è®°ä¸ºcï¼ŒåŠ æ ‡è®°ä¸º0ã€‚
- å¯¹äºç½®cï¼Œä¹˜æ ‡è®°ä¸º0ï¼ŒåŠ æ ‡è®°ä¸ºcã€‚
ç”±æ­¤æˆ‘ä»¬å°±ç¡®å®šäº†æ›´æ–°å»¶è¿Ÿæ ‡è®°ä»¥åŠæ›´æ–°åŒºé—´çš„æ–¹æ³•ã€‚å¯¹äºæŸ¥è¯¢pæ¬¡æ–¹ï¼Œå¹³æ–¹å’Œç«‹æ–¹éœ€è¦å±•å¼€
****
å—¯...å‘ç°å¥½åƒç»“æ„ä½“ä¼šå¥½ç†è§£å‘¢(å½“å†™å®Œæ‰å‘ç°ã€‚ã€‚ã€‚å“­äº†)

æ¯å…·äº†ï¼Œä»£ç èƒ½è¿‡æ ·ä¾‹ï¼Œä½†æ˜¯åœ¨hduä¸Šé¢æµ‹è¯•ä¼šTLEã€‚ã€‚æ²¡æ‡‚å‘ç”Ÿäº†ä»€ä¹ˆã€‚ã€‚
```c++
#include<iostream>  
#include<cmath>  

using namespace std;  

typedef long long ll;  
const int N = 1e5 + 10, MOD = 10007;  

ll sum1[N * 4], sum2[N * 4], sum3[N * 4]; // è¡¨ç¤ºç¬¬iä¸ªèŠ‚ç‚¹çš„å€¼  
ll tag1[N * 4], tag2[N * 4];  // tag1 å­˜åŠ æ³•ï¼Œ tag2å­˜ä¹˜æ³•

// å»ºæ ‘éƒ¨åˆ†å› ä¸ºåˆå§‹éƒ½æ˜¯0ï¼Œæ‰€ä»¥ä¸éœ€è¦push_upæ“ä½œ
void build(int p, int pl, int pr){  
	sum1[p] = sum2[p] = sum3[p] = tag1[p] = 0;  // åˆå§‹åŒ–
	tag2[p] = 1;
	
	if(pl == pr) return;
	// æœ€åº•å±‚çš„å¶å­èŠ‚ç‚¹ï¼Œå­˜å¶å­èŠ‚ç‚¹çš„å€¼  
	
	ll mid = ((pl + pr) >> 1); // åˆ†æ²»ï¼šæŠ˜åŠ  
	
	build(p * 2, pl, mid); // é€’å½’å·¦å„¿å­  
	build(p * 2 + 1, mid + 1, pr); // é€’å½’å³å„¿å­  
}  
// æ›´æ–°lazy-tag
inline void addtag(ll p, ll pl, ll pr, ll d1, ll d2){
	// d1 ä¸º+ï¼Œd2 ä¸º * 
	int len = pr - pl + 1;
	// è®¡ç®—ä¸‰ç§æ±‚å’Œæ–¹å¼çš„ç»“æœ
	sum3[p] = (((d1*d1*d1)%MOD * sum3[p]) % MOD + ((d2*d2*d2) % MOD * len) % MOD + ((3ll * d1 * d2 * d2) % MOD * sum1[p]) % MOD+((3ll*d1*d1*d2) % MOD * sum2[p])%MOD)%MOD;
	sum2[p] = ((d1 * d1 * sum2[p]) % MOD + (2ll * d1 * d2 * sum1[p]) % MOD + (d2 * d2 * len) % MOD) % MOD;
	sum1[p] = ((d1 * sum1[p]) % MOD + d2 * len % MOD) % MOD;

	tag2[p] = (tag2[p] * d1)%MOD;  // ä¹˜æ›´æ–°
	tag1[p] = (tag1[p] * d1 + d2)%MOD;  // åŠ æ›´æ–°
	
}

inline void push_down(ll p, ll pl, ll pr){
	// å¦‚æœlazy-tagä¸Šé¢æœ‰å†…å®¹ï¼Œé‚£ä¹ˆzaåœ¨push-downæ—¶éœ€è¦è¢«æ›´æ–°
	if(tag1[p] || tag2[p] != 1){
		ll mid = (pr + pl) >> 1;
		addtag(p  * 2, pl, mid, tag2[p], tag1[p]);
		addtag(p * 2 + 1, mid + 1, pr, tag2[p], tag1[p]);
		tag1[p] = 0;
		tag2[p] = 1;
	}
}

void update(ll l, ll r, ll p, ll pl, ll pr, ll d1, ll d2){  
	if(l <= pl && pr <= r ){  
		addtag(p, pl, pr, d1, d2);
		return;  
	}  
	
	push_down(p, pl, pr);
	
	ll mid = (pl + pr) >> 1;  
	if(l <= mid) update(l, r, p * 2, pl, mid, d1, d2); // é€’å½’å·¦å­æ ‘  
	if(r > mid) update(l, r, p * 2 + 1, mid + 1, pr, d1, d2); // é€’å½’å³å­æ ‘  
	
	sum1[p] = (sum1[p * 2] + sum1[p * 2 + 1]) % MOD;
	sum2[p] = (sum2[p * 2] + sum2[p * 2 + 1]) % MOD;
	sum3[p] = (sum3[p * 2] + sum3[p * 2 + 1]) % MOD;
}  

// å¯¹åŸæœ¬çš„getsumåªæ˜¯ä¿®æ”¹äº†è¯»å–çš„c
ll getsum(int l, int r, int p, int pl, int pr, int c){  
	if(l <= pl && pr <= r){
		if(c == 1) return sum1[p]; // å®Œå…¨è¦†ç›–ï¼Œç›´æ¥è¿”å›  
		else if(c == 2) return sum2[p]; // å®Œå…¨è¦†ç›–ï¼Œç›´æ¥è¿”å›  
		else return sum3[p]; // å®Œå…¨è¦†ç›–ï¼Œç›´æ¥è¿”å› 
	}
	
	ll mid = (pl + pr) >> 1, res = 0;  
	// æŸ¥è¯¢çš„è¿‡ç¨‹ä¹Ÿéœ€è¦push-down
	push_down(p, pl, pr);  // å¦‚æœä¸èƒ½è¦†ç›–ï¼ŒæŠŠtagä¼ ç»™å­æ ‘
	
	if(l <= mid) res += getsum(l, r, p * 2, pl, mid, c); // é€’å½’æŸ¥è¯¢å·¦å„¿å­ 
	if(r > mid) res += getsum(l, r, p * 2 + 1, mid + 1, pr, c); // é€’å½’æŸ¥è¯¢å³å„¿å­
	return res;  
}  

int main(void){  
	int n, m, op, x, y, c;  
	
	// æ³¨æ„æ­¤å¤„çš„è¯»å…¥æŠ€å·§
	while(~scanf("%d%d",&n,&m) && n && m){
		build(1, 1, n);
		while(m--){
			scanf("%d%d%d%d", &op, &x, &y, &c);
			if(op == 1){
				update(x, y, 1, 1, n, 1, c);  // åªæ”¹å˜+æ“ä½œï¼Œä¸æ”¹å˜*æ“ä½œ
			}else if(op == 2){
				update(x, y, 1, 1, n, c, 0); // åªæ”¹å˜*æ“ä½œï¼Œä¸æ”¹å˜+æ“ä½œ
			}else if(op == 3){
				update(x, y, 1, 1, n, 0, c); // æ”¹å˜+æ“ä½œï¼Œ*æ“ä½œè®¾ä¸º0ï¼Œè¿™æ ·lazytagå°±å˜æˆäº†cçš„å€¼
			}else{
				ll ans = getsum(x, y, 1, 1, n, c) % MOD;
				printf("%lld\n", ans);
			}
		}
	}
	
	return 0;  
}
```

### çº¿æ®µæ ‘ + äºŒåˆ†
hdu 4614
```c++
#include<cstdio>
#include<algorithm>
#define L k<<1
#define R k<<1|1
#define mid (tree[k].l+tree[k].r)>>1
using namespace std;
const int MAXN = 50000+5;

struct segmemt_tree {
    int l, r;
    int num, f;
} tree[4*MAXN+1];

inline void build(int k, int l, int r) {
    tree[k].l = l; tree[k].r = r;
    tree[k].num = 0;
    tree[k].f = -1;
    if(l == r) return ;
    int m = mid;
    build(L, l, m);
    build(R, m+1, r);
}

inline void push_down(int k) {
    tree[L].f = tree[R].f = tree[k].f;
    int m = mid;
    tree[L].num = (m-tree[k].l+1) * tree[k].f;
    tree[R].num = (tree[k].r-m) * tree[k].f;
    tree[k].f = -1;
}

inline int query(int k, int x, int y) {// æŸ¥è¯¢åŒºé—´å†…æ’å…¥èŠ±çš„æ•°é‡
    if(tree[k].l >= x && tree[k].r <= y) return tree[k].num;
    if(tree[k].f != -1) push_down(k);
    int m = mid;
    int ans = 0;
    if(x <= m) ans = query(L, x, y);
    if(y > m) ans += query(R, x, y);
    return ans;
}

inline int bin(int start, int end, int cnt) {// äºŒåˆ†æŸ¥æ‰¾ l=start åˆ° r=end ç¬¬cntä¸ªç©ºèŠ±ç“¶
    int l = start, r = end;
    while(l < r) {
        int m = (l + r) / 2;
        int t = (m - start + 1) - query(1, start, m);
        if(t >= cnt) r = m;
        else l = m + 1;
    }
    return l;
}

inline void change(int k, int x, int y, int v) {
    if(tree[k].l >= x && tree[k].r <= y) {
        tree[k].f = v;
        tree[k].num = (tree[k].r - tree[k].l + 1) * v;
        return ;
    }
    if(tree[k].f != -1) push_down(k);
    int m = mid;
    if(x <= m) change(L, x, y, v);
    if(y > m) change(R, x, y, v);
    tree[k].num = tree[L].num + tree[R].num;
}

int main() {
    int T;
    scanf("%d", &T);
    while(T--) {
        int n, m;
        scanf("%d%d", &n, &m);
        build(1, 0, n-1);
        int op, x, y;
        int s, e;
        for(int i = 0; i != m; ++i) {
            scanf("%d%d%d", &op, &x, &y);
            if(op == 1) {
                int one = query(1, x, n-1);
                if(one == n-1-x+1) printf("Can not put any one.\n");
                else {
                    s = bin(x, n-1, 1);// ç¬¬ä¸€ä¸ªç©ºèŠ±ç“¶ä½ç½®
                    e = bin(s, n-1, min(n-1-x+1-one, y));// æœ€åä¸€ä¸ªç©ºèŠ±ç“¶ä½ç½®
                    printf("%d %d\n", s, e);
                    change(1, s, e, 1);
                }
            }
            else printf("%d\n", query(1, x, y)), change(1, x, y, 0);
        }
        printf("\n");
    }
    return 0;
}
```

### åŒºé—´å†å²æœ€å€¼
[P6242 ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘ 3ï¼ˆåŒºé—´æœ€å€¼æ“ä½œã€åŒºé—´å†å²æœ€å€¼ï¼‰](https://www.luogu.com.cn/problem/P6242)
## é¢˜ç›®æè¿°
ç»™å‡ºä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„æ•°åˆ— $A$ï¼ŒåŒæ—¶å®šä¹‰ä¸€ä¸ªè¾…åŠ©æ•°ç»„ $B$ï¼Œ$B$ å¼€å§‹ä¸ $A$ å®Œå…¨ç›¸åŒã€‚æ¥ä¸‹æ¥è¿›è¡Œäº† $m$ æ¬¡æ“ä½œï¼Œæ“ä½œæœ‰äº”ç§ç±»å‹ï¼ŒæŒ‰ä»¥ä¸‹æ ¼å¼ç»™å‡ºï¼š
- `1 l r k`ï¼šå¯¹äºæ‰€æœ‰çš„ $i\in[l,r]$ï¼Œå°† $A_i$ åŠ ä¸Š $k$ï¼ˆ$k$ å¯ä»¥ä¸ºè´Ÿæ•°ï¼‰ã€‚
- `2 l r v`ï¼šå¯¹äºæ‰€æœ‰çš„ $i\in[l,r]$ï¼Œå°† $A_i$ å˜æˆ $\min(A_i,v)$ã€‚
- `3 l r`ï¼šæ±‚ $\sum_{i=l}^{r}A_i$ã€‚
- `4 l r`ï¼šå¯¹äºæ‰€æœ‰çš„ $i\in[l,r]$ï¼Œæ±‚ $A_i$ çš„æœ€å¤§å€¼ã€‚
- `5 l r`ï¼šå¯¹äºæ‰€æœ‰çš„ $i\in[l,r]$ï¼Œæ±‚ $B_i$ çš„æœ€å¤§å€¼ã€‚
åœ¨æ¯ä¸€æ¬¡æ“ä½œåï¼Œæˆ‘ä»¬éƒ½è¿›è¡Œä¸€æ¬¡æ›´æ–°ï¼Œè®© $B_i\gets\max(B_i,A_i)$ã€‚

```c++
#include<bits/stdc++.h>                                                   
#define ll long long
using namespace std;
char buf[1<<21],*p1=buf,*p2=buf,obuf[1<<21],*o=obuf;
#define g()(p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)
inline int read()
{
    int s=0,f=1;char c=g();
    for(;!isdigit(c);c=g())
		if(c=='-')f=-1;
    for(;isdigit(c);c=g())
		s=s*10+c-'0';
    return s*f;
}
inline void write(ll x)
{
    static char buf[20];
    static int len=-1;
    if(x<0)putchar('-'),x=-x;
    do buf[++len]=x%10,x/=10;while(x);
    while(len>=0)putchar(buf[len--]+'0');
    putchar('\n');
}
int n,m,op,l,r,k,v;
struct segment_tree{
	ll sum;
	int l,r,maxa,cnt,se,maxb;
	int add1,add2,add3,add4;
}s[2000005];
inline void push_up(int p)
{
	s[p].sum=s[p*2].sum+s[p*2+1].sum;
	s[p].maxa=max(s[p*2].maxa,s[p*2+1].maxa);
	s[p].maxb=max(s[p*2].maxb,s[p*2+1].maxb);
	if(s[p*2].maxa==s[p*2+1].maxa)
	{
		s[p].se=max(s[p*2].se,s[p*2+1].se);
		s[p].cnt=s[p*2].cnt+s[p*2+1].cnt;
	}
	else if(s[p*2].maxa>s[p*2+1].maxa)
	{
		s[p].se=max(s[p*2].se,s[p*2+1].maxa);
		s[p].cnt=s[p*2].cnt;
	}
	else
	{
		s[p].se=max(s[p*2].maxa,s[p*2+1].se);
		s[p].cnt=s[p*2+1].cnt;
	}
}
void build(int l,int r,int p)
{
	s[p].l=l,s[p].r=r;
	if(l==r)
	{
		s[p].sum=s[p].maxa=s[p].maxb=read();
		s[p].cnt=1,s[p].se=-2e9;
		return;
	}
	int mid=(l+r)/2;
	build(l,mid,p*2);
	build(mid+1,r,p*2+1);
	push_up(p);
}
inline void change(int k1,int k2,int k3,int k4,int p)
{
	s[p].sum+=1ll*k1*s[p].cnt+1ll*k2*(s[p].r-s[p].l+1-s[p].cnt);
	s[p].maxb=max(s[p].maxb,s[p].maxa+k3);
	s[p].maxa+=k1;
	if(s[p].se!=-2e9)s[p].se+=k2;
	s[p].add3=max(s[p].add3,s[p].add1+k3);
	s[p].add4=max(s[p].add4,s[p].add2+k4);
	s[p].add1+=k1,s[p].add2+=k2;
}
inline void push_down(int p)
{
	int maxn=max(s[p*2].maxa,s[p*2+1].maxa);
	if(s[p*2].maxa==maxn)
	    change(s[p].add1,s[p].add2,s[p].add3,s[p].add4,p*2);
	else change(s[p].add2,s[p].add2,s[p].add4,s[p].add4,p*2);
	if(s[p*2+1].maxa==maxn)
		change(s[p].add1,s[p].add2,s[p].add3,s[p].add4,p*2+1);
	else change(s[p].add2,s[p].add2,s[p].add4,s[p].add4,p*2+1);
	s[p].add1=s[p].add2=s[p].add3=s[p].add4=0;
}
void update_add(int p)
{
	if(l>s[p].r||r<s[p].l)return;
	if(l<=s[p].l&&s[p].r<=r)
	{	
		s[p].sum+=1ll*k*s[p].cnt+1ll*k*(s[p].r-s[p].l+1-s[p].cnt);
		s[p].maxa+=k;
		s[p].maxb=max(s[p].maxb,s[p].maxa);
		if(s[p].se!=-2e9)s[p].se+=k;
		s[p].add1+=k,s[p].add2+=k;
		s[p].add3=max(s[p].add3,s[p].add1);
		s[p].add4=max(s[p].add4,s[p].add2);
		return;
	}
	push_down(p);
	update_add(p*2),update_add(p*2+1);
	push_up(p);
}
void update_min(int p)
{
	if(l>s[p].r||r<s[p].l||v>=s[p].maxa)return;
	if(l<=s[p].l&&s[p].r<=r&&s[p].se<v)
	{
		int k=s[p].maxa-v;
		s[p].sum-=1ll*s[p].cnt*k;
		s[p].maxa=v,s[p].add1-=k;
		return;
	}
	push_down(p);
	update_min(p*2),update_min(p*2+1);
	push_up(p);
}
ll query_sum(int p)
{
	if(l>s[p].r||r<s[p].l)return 0;
	if(l<=s[p].l&&s[p].r<=r)return s[p].sum;
	push_down(p);
	return query_sum(p*2)+query_sum(p*2+1);
}
int query_maxa(int p)
{
	if(l>s[p].r||r<s[p].l)return -2e9;
	if(l<=s[p].l&&s[p].r<=r)return s[p].maxa;
	push_down(p);
	return max(query_maxa(p*2),query_maxa(p*2+1));
}
int query_maxb(int p)
{
	if(l>s[p].r||r<s[p].l)return -2e9;
	if(l<=s[p].l&&s[p].r<=r)return s[p].maxb;
	push_down(p);
	return max(query_maxb(p*2),query_maxb(p*2+1));
}
int main()
{
	n=read(),m=read();
	build(1,n,1);
	while(m--)
	{
		op=read(),l=read(),r=read();
		if(op==1)k=read(),update_add(1);
		else if(op==2)v=read(),update_min(1);
		else if(op==3)write(query_sum(1));
		else if(op==4)printf("%d\n",query_maxa(1));
		else printf("%d\n",query_maxb(1));
	}
	return 0;
}
```

